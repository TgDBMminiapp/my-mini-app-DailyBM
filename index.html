<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DailyBookimix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ff4500">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –°–¢–ò–õ–ò –í–ó–Ø–¢–´ –ò–ó –ü–ï–†–í–û–ô –í–ï–†–°–ò–ò (—á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å —Ñ–æ–Ω/–≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é) --- */
        :root {
            --bg-gradient-light: linear-gradient(135deg, #ff4500 0%, #ff6b35 25%, #f7931e 50%, #ff8c42 75%, #ff5722 100%);
            --bg-gradient-dark: linear-gradient(135deg, #0f1724 0%, #1f2937 30%, #2d3748 60%, #111827 100%);
            --text-primary-light: #ffffff;
            --text-secondary-light: #ffdab9;
            --bg-glass-light: rgba(0, 0, 0, 0.4);
            --border-light: rgba(255, 255, 255, 0.3);
            --bg-glass-dark: rgba(255, 255, 255, 0.06);
            --border-dark: rgba(0, 0, 0, 0.3);
        }

        html, body {
            height: 100%;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            background-size: cover;
            background-attachment: fixed;
        }

        body {
            box-sizing: border-box;
            background: var(--bg-gradient-light);
            color: var(--text-primary-light);
        }

        body.dark {
            background: var(--bg-gradient-dark);
            color: #e5e7eb;
        }

        .glass-effect {
            background: var(--bg-glass-light);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-light);
        }

        .dark .glass-effect {
            background: var(--bg-glass-dark);
            border: 1px solid var(--border-dark);
        }

        .note-card { transition: all 0.3s ease; transform: translateY(0); }
        .note-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }

        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(20px);} to { opacity:1; transform: translateY(0);} }

        .tab-button { background: rgba(0,0,0,0.3); flex:1 1 0; min-width:0; }
        .tab-button.active { background: rgba(255,255,255,0.9); color: #1f2937; }

        .notification { position: fixed; top: 20px; right: 20px; padding: 16px; border-radius: 8px; color: white; z-index: 1000; animation: fadeIn 0.3s; }
        .notification.success { background-color: #4caf50; }
        .notification.error { background-color: #f44336; }
        .notification.info { background-color: #2196f3; }

        /* —É–±—Ä–∞–ª status-indicator —Å—Ç–∏–ª–∏ –∏ —ç–ª–µ–º–µ–Ω—Ç ‚Äî –ø–æ –ø—Ä–æ—Å—å–±–µ (—É–¥–∞–ª–∏–ª –∑–µ–ª—ë–Ω—É—é –∫–Ω–æ–ø–∫—É) */
    </style>
</head>
<body class="font-sans">
    <div class="min-h-screen p-4 flex flex-col">
        <!-- Header -->
        <header class="glass-effect rounded-2xl p-6 mb-6 fade-in">
            <div class="flex items-center justify-between flex-wrap">
                <div class="flex items-center space-x-3 mb-4 sm:mb-0">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white" id="app-title">DailyBookimix</h1>
                        <p class="text-orange-100 text-sm" id="app-desc">–ó–∞—â–∏—â—ë–Ω–Ω—ã–π –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫</p>
                    </div>
                </div>

                <!-- –§–∏—à–∫–∏: –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ –∏ —Ç–µ–º—ã (–Ω–µ –º–µ–Ω—è—é—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ñ–æ–Ω –ø–æ–∫–∞ –Ω–µ –≤–∫–ª—é—á–µ–Ω—ã) -->
                <div class="flex items-center space-x-2 mb-4 sm:mb-0">
                    <button id="langSwitch" class="px-3 py-1 bg-white/20 rounded-lg text-white text-sm hover:bg-white/30">English</button>
                    <button id="themeSwitch" class="px-3 py-1 bg-white/20 rounded-lg text-white text-sm hover:bg-white/30">Dark</button>
                    <div class="security-badge px-4 py-2 rounded-full">
                        <span class="text-white text-sm font-medium flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                            </svg>
                            <span id="cloud-label">–û–±–ª–∞—á–Ω–æ</span>
                        </span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="glass-effect rounded-2xl p-2 mb-6 fade-in">
            <div class="flex space-x-2">
                <button id="notesTab" class="tab-button active py-3 px-4 rounded-xl text-white font-medium transition-all duration-200">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span id="notes-tab">–ó–∞–ø–∏—Å–∏</span>
                </button>
                <button id="habitsTab" class="tab-button py-3 px-4 rounded-xl text-purple-200 font-medium transition-all duration-200">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span id="habits-tab">–ü—Ä–∏–≤—ã—á–∫–∏</span>
                </button>
                <button id="memoryTab" class="tab-button py-3 px-4 rounded-xl text-purple-200 font-medium transition-all duration-200">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                    <span id="memory-tab">–ê—Ä—Ö–∏–≤</span>
                </button>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (—Ñ–æ—Ä–º—ã –∏ —Å–ø–∏—Å–∫–∏) -->
        <div id="notesSection" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Add Note Form -->
            <div class="md:col-span-1">
                <div class="glass-effect rounded-2xl p-6 fade-in">
                    <h2 class="text-xl font-semibold text-white mb-4 flex items-center" id="new-note-title">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å
                    </h2>

                    <form id="noteForm" class="space-y-4">
                        <div>
                            <label class="block text-purple-100 text-sm font-medium mb-2" id="note-title-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                            <input type="text" id="noteTitle" required
                                   class="w-full px-4 py-3 bg-white/90 border border-white/50 rounded-xl text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-purple-100 text-sm font-medium mb-2" id="note-category-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <select id="noteCategory"
                                    class="w-full px-4 py-3 bg-white/90 border border-white/50 rounded-xl text-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent">
                                <option value="personal">–õ–∏—á–Ω–æ–µ</option>
                                <option value="work">–†–∞–±–æ—Ç–∞</option>
                                <option value="ideas">–ò–¥–µ–∏</option>
                                <option value="tasks">–ó–∞–¥–∞—á–∏</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-purple-100 text-sm font-medium mb-2" id="note-content-label">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</label>
                            <textarea id="noteContent" required rows="4"
                                      class="w-full px-4 py-3 bg-white/90 border border-white/50 rounded-xl text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent resize-y"></textarea>
                        </div>

                        <button type="submit"
                                class="w-full bg-white text-orange-600 font-semibold py-3 px-6 rounded-xl hover:bg-orange-50 transition-colors duration-200 flex items-center justify-center" id="save-note-btn">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </form>
                </div>
            </div>

            <!-- Notes List -->
            <div class="md:col-span-2">
                <div class="glass-effect rounded-2xl p-6 fade-in">
                    <div class="flex items-center justify-between mb-6 flex-wrap">
                        <h2 class="text-xl font-semibold text-white flex items-center mb-4 sm:mb-0" id="my-notes-title">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                            </svg>
                            –ú–æ–∏ –∑–∞–ø–∏—Å–∏
                        </h2>

                        <div class="flex space-x-2">
                            <input type="text" id="notesSearch" class="px-3 py-2 bg-white/90 border border-white/50 rounded-lg text-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-orange-400" placeholder="–ü–æ–∏—Å–∫..." style="width: 200px;">
                            <select id="filterCategory"
                                    class="px-3 py-2 bg-white/90 border border-white/50 rounded-lg text-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-orange-400">
                                <option value="all">–í—Å–µ</option>
                                <option value="personal">–õ–∏—á–Ω–æ–µ</option>
                                <option value="work">–†–∞–±–æ—Ç–∞</option>
                                <option value="ideas">–ò–¥–µ–∏</option>
                                <option value="tasks">–ó–∞–¥–∞—á–∏</option>
                            </select>

                            <button id="clearAll"
                                    class="px-4 py-2 bg-red-500/80 text-white rounded-lg hover:bg-red-600/80 transition-colors duration-200 text-sm">
                                –û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                        </div>
                    </div>

                    <div id="notesList" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                        <div id="emptyState" class="text-center py-12">
                            <svg class="w-16 h-16 text-purple-200 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p class="text-purple-200 text-lg">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>
                            <p class="text-purple-300 text-sm mt-2">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Habits (–∫–∞–∫ –±—ã–ª–æ) -->
        <div id="habitsSection" class="grid grid-cols-1 md:grid-cols-3 gap-6 hidden">
            <div class="md:col-span-1">
                <div class="glass-effect rounded-2xl p-6 fade-in">
                    <h2 class="text-xl font-semibold text-white mb-4">–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞</h2>
                    <form id="habitForm" class="space-y-4">
                        <input type="text" id="habitName" required placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="w-full px-4 py-3 bg-white/90 rounded-xl">
                        <input type="date" id="habitStartDate" required class="w-full px-4 py-3 bg-white/90 rounded-xl">
                        <input type="number" id="habitGoal" min="1" value="30" required placeholder="–¶–µ–ª—å (–¥–Ω–µ–π)" class="w-full px-4 py-3 bg-white/90 rounded-xl">
                        <textarea id="habitDescription" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" class="w-full px-4 py-3 bg-white/90 rounded-xl"></textarea>
                        <button type="submit" class="w-full bg-white text-orange-600 font-semibold py-3 px-6 rounded-xl">–ù–∞—á–∞—Ç—å</button>
                    </form>
                </div>
            </div>
            <div class="md:col-span-2">
                <div class="glass-effect rounded-2xl p-6 fade-in">
                    <h2 class="text-xl font-semibold text-white mb-6">–ú–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏</h2>
                    <div id="habitsList" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <!-- Memory Section (–∫–∞–∫ –±—ã–ª–æ) -->
        <div id="memorySection" class="grid grid-cols-1 md:grid-cols-3 gap-6 hidden">
            <div class="md:col-span-1">
                <div class="glass-effect rounded-2xl p-6 fade-in">
                    <h2 class="text-xl font-semibold text-white mb-4">–ù–æ–≤–æ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ</h2>
                    <form id="memoryForm" class="space-y-4">
                        <input type="text" id="memoryTitle" required placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="w-full px-4 py-3 bg-white/90 rounded-xl">
                        <select id="memoryType" class="w-full px-4 py-3 bg-white/90 rounded-xl">
                            <option value="book">üìö –ö–Ω–∏–≥–∞</option>
                            <option value="movie">üé¨ –§–∏–ª—å–º</option>
                            <option value="series">üì∫ –°–µ—Ä–∏–∞–ª</option>
                            <option value="game">üéÆ –ò–≥—Ä–∞</option>
                        </select>
                        <input type="date" id="memoryStartDate" required class="w-full px-4 py-3 bg-white/90 rounded-xl">
                        <textarea id="memoryNotes" rows="4" placeholder="–ó–∞–º–µ—Ç–∫–∏" class="w-full px-4 py-3 bg-white/90 rounded-xl"></textarea>
                        <button type="submit" class="w-full bg-white text-orange-600 font-semibold py-3 px-6 rounded-xl">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </form>
                </div>
            </div>
            <div class="md:col-span-2">
                <div class="glass-effect rounded-2xl p-6 fade-in">
                    <h2 class="text-xl font-semibold text-white mb-6">–ê—Ä—Ö–∏–≤ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π</h2>
                    <div id="memoriesList" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-auto glass-effect rounded-2xl p-4 fade-in">
            <div class="flex flex-wrap justify-center space-x-4 text-purple-100 text-sm">
                <span>üìä –ó–∞–ø–∏—Å–µ–π: <span id="notesCount">0</span></span>
                <span>‚è∞ –ü—Ä–∏–≤—ã—á–µ–∫: <span id="habitsCount">0</span></span>
                <span>üìñ –í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π: <span id="memoriesCount">0</span></span>
            </div>
        </footer>
    </div>

    <script>
        // --- –ü–µ—Ä–µ–Ω—ë—Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π/–æ–±—ë—Ä—Ç–æ–∫ (CloudStorage) –∏–∑ –≤–∞—à–∏—Ö —Ñ–∞–π–ª–æ–≤.
        function cloudSetItem(key, value) {
            return new Promise((resolve, reject) => {
                Telegram.WebApp.CloudStorage.setItem(key, value, (err, success) => {
                    if (err) reject(err); else resolve(success);
                });
            });
        }
        function cloudGetItem(key) {
            return new Promise((resolve, reject) => {
                Telegram.WebApp.CloudStorage.getItem(key, (err, value) => {
                    if (err) reject(err); else resolve(value || null);
                });
            });
        }
        function cloudGetItems(keys) {
            return new Promise((resolve, reject) => {
                Telegram.WebApp.CloudStorage.getItems(keys, (err, values) => {
                    if (err) reject(err); else resolve(values || {});
                });
            });
        }
        function cloudRemoveItem(key) {
            return new Promise((resolve, reject) => {
                Telegram.WebApp.CloudStorage.removeItem(key, (err, success) => {
                    if (err) reject(err); else resolve(success);
                });
            });
        }

        const CloudStorageManager = {
            async get(key, defaultValue) {
                try {
                    const v = await cloudGetItem(key);
                    return v !== null ? v : defaultValue;
                } catch (e) {
                    console.error('Cloud get error:', e);
                    return defaultValue;
                }
            },
            async set(key, value) {
                try {
                    await cloudSetItem(key, value);
                    return true;
                } catch (e) {
                    console.error('Cloud set error:', e);
                    return false;
                }
            }
        };

        class SimpleDiary {
            constructor() {
                this.notes = [];
                this.habits = [];
                this.memories = [];
                this.currentTab = 'notes';
                this.lang = 'ru';
                this.theme = 'light';
            }

            /* --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è —Å –≤–∞—à–µ–π –ø–µ—Ä–≤–æ–π –≤–µ—Ä—Å–∏–µ–π) --- */
            async loadAll() {
                try {
                    const data = await cloudGetItems(['notes','habits','memories']);
                    this.notes = JSON.parse(data.notes || '[]');
                    this.habits = JSON.parse(data.habits || '[]');
                    this.memories = JSON.parse(data.memories || '[]');
                    this.renderNotes();
                    this.renderHabits();
                    this.renderMemories();
                    this.updateCounts();
                } catch (e) {
                    console.error('Load error:', e);
                }
            }

            async loadSettings() {
                this.lang = await CloudStorageManager.get('lang', 'ru');
                this.theme = await CloudStorageManager.get('theme', 'light');
                this.applyLang();
                this.applyTheme();
            }

            async saveNotes() {
                await CloudStorageManager.set('notes', JSON.stringify(this.notes));
                this.updateCounts();
            }
            async saveHabits() {
                await CloudStorageManager.set('habits', JSON.stringify(this.habits));
                this.updateCounts();
            }
            async saveMemories() {
                await CloudStorageManager.set('memories', JSON.stringify(this.memories));
                this.updateCounts();
            }

            extractHashtags(content) {
                // –∏—â–µ—Ç #word (–±—É–¥–µ—Ç –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ö—ç—à—Ç–µ–≥–∞–º)
                const matches = content.match(/#\w+/g);
                return matches ? matches.map(m => m.trim()) : [];
            }

            async addNote() {
                const title = document.getElementById('noteTitle').value.trim();
                const category = document.getElementById('noteCategory').value;
                const content = document.getElementById('noteContent').value.trim();
                if (!title || !content) {
                    alert(this.lang === 'ru' ? '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è' : 'Fill all fields');
                    return;
                }
                const note = {
                    id: Date.now(),
                    title,
                    category,
                    content,
                    hashtags: this.extractHashtags(content),
                    date: new Date().toLocaleString(this.lang === 'ru' ? 'ru-RU' : 'en-US')
                };
                this.notes.unshift(note);
                await this.saveNotes();
                this.renderNotes();
                document.getElementById('noteForm').reset();
                this.showNotification(this.lang === 'ru' ? '–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞' : 'Note saved', 'success');
            }

            async deleteNote(id) {
                if (confirm(this.lang === 'ru' ? '–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?' : 'Delete note?')) {
                    this.notes = this.notes.filter(n => n.id !== id);
                    await this.saveNotes();
                    this.renderNotes();
                    this.showNotification(this.lang === 'ru' ? '–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞' : 'Note deleted', 'info');
                }
            }

            renderNotes() {
                const list = document.getElementById('notesList');
                const empty = document.getElementById('emptyState');
                const searchRaw = (document.getElementById('notesSearch').value || '').toLowerCase();
                const categoryFilter = document.getElementById('filterCategory').value;
                let filtered = this.notes.slice();

                if (categoryFilter !== 'all') filtered = filtered.filter(n => n.category === categoryFilter);

                if (searchRaw) {
                    const search = searchRaw.replace('#',''); // –µ—Å–ª–∏ –≤–≤–µ–ª–∏ #tag –∏–ª–∏ tag
                    filtered = filtered.filter(note =>
                        note.title.toLowerCase().includes(search) ||
                        note.content.toLowerCase().includes(search) ||
                        note.hashtags.some(tag => tag.toLowerCase().includes(search))
                    );
                }

                if (filtered.length === 0) {
                    empty.style.display = 'block';
                    list.innerHTML = '';
                    list.appendChild(empty);
                    return;
                }
                empty.style.display = 'none';

                const categoryColors = { personal: 'bg-pink-500', work: 'bg-blue-500', ideas: 'bg-yellow-500', tasks: 'bg-green-500' };
                const categoryNames = this.lang === 'ru' ? { personal: '–õ–∏—á–Ω–æ–µ', work: '–†–∞–±–æ—Ç–∞', ideas: '–ò–¥–µ–∏', tasks: '–ó–∞–¥–∞—á–∏' } : { personal: 'Personal', work: 'Work', ideas: 'Ideas', tasks: 'Tasks' };

                list.innerHTML = filtered.map(note => `
                    <div class="note-card bg-black/30 backdrop-blur-sm border border-white/30 rounded-xl p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <span class="${categoryColors[note.category]} px-3 py-1 rounded-full text-white text-xs font-medium">${categoryNames[note.category]}</span>
                                <span class="text-orange-200 text-xs">${note.date}</span>
                            </div>
                            <button onclick="diary.deleteNote(${note.id})" class="text-red-300 hover:text-red-200">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                        <h3 class="text-white font-semibold text-lg mb-2">${note.title}</h3>
                        <p class="text-orange-100 leading-relaxed">${note.content}</p>
                        ${note.hashtags && note.hashtags.length > 0 ? `<div class="flex flex-wrap gap-1 mt-2">${note.hashtags.map(tag => `<button class="bg-white/20 px-2 py-1 rounded-full text-purple-100 text-xs" onclick="diary.filterByHashtag('${tag.replace('#','')}')">${tag}</button>`).join('')}</div>` : ''}
                    </div>
                `).join('');
            }

            // –∫–ª–∏–∫ –ø–æ —Ö—ç—à—Ç–µ–≥—É ‚Äî —Å—Ç–∞–≤–∏–º –µ–≥–æ –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
            filterByHashtag(tag) {
                const inp = document.getElementById('notesSearch');
                inp.value = '#' + tag;
                this.renderNotes();
            }

            async addHabit() {
                const name = document.getElementById('habitName').value.trim();
                const startDate = document.getElementById('habitStartDate').value;
                const goal = parseInt(document.getElementById('habitGoal').value);
                const description = document.getElementById('habitDescription').value.trim();
                if (!name || !startDate) {
                    alert(this.lang === 'ru' ? '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è' : 'Fill all fields');
                    return;
                }
                const habit = { id: Date.now(), name, startDate, goal, description, completedDays: [] };
                this.habits.unshift(habit);
                await this.saveHabits();
                this.renderHabits();
                document.getElementById('habitForm').reset();
                document.getElementById('habitStartDate').value = new Date().toISOString().split('T')[0];
                this.showNotification(this.lang === 'ru' ? '–ü—Ä–∏–≤—ã—á–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞' : 'Habit added', 'success');
            }

            async deleteHabit(id) {
                if (confirm(this.lang === 'ru' ? '–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É?' : 'Delete habit?')) {
                    this.habits = this.habits.filter(h => h.id !== id);
                    await this.saveHabits();
                    this.renderHabits();
                    this.showNotification(this.lang === 'ru' ? '–ü—Ä–∏–≤—ã—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞' : 'Habit deleted', 'info');
                }
            }

            async toggleHabitDay(id) {
                const habit = this.habits.find(h => h.id === id); if (!habit) return;
                const today = new Date().toISOString().split('T')[0];
                const idx = habit.completedDays.indexOf(today);
                if (idx > -1) habit.completedDays.splice(idx,1); else habit.completedDays.push(today);
                await this.saveHabits(); this.renderHabits();
            }

            renderHabits() {
                const list = document.getElementById('habitsList');
                if (this.habits.length === 0) { list.innerHTML = `<p class="text-purple-200 text-center">${this.lang==='ru'?'–ù–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫':'No habits'}</p>`; return; }
                list.innerHTML = this.habits.map(habit => {
                    const progress = Math.min((habit.completedDays.length / habit.goal) * 100, 100);
                    const isCompletedToday = habit.completedDays.includes(new Date().toISOString().split('T')[0]);
                    return `
                        <div class="note-card bg-black/30 backdrop-blur-sm border border-white/30 rounded-xl p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex-1">
                                    <h3 class="text-white font-semibold text-xl mb-2">${habit.name}</h3>
                                    <p class="text-purple-200 text-sm">${habit.description || ''}</p>
                                </div>
                                <button onclick="diary.deleteHabit(${habit.id})" class="text-red-300 hover:text-red-200">üóë</button>
                            </div>
                            <div class="grid grid-cols-3 gap-4 mb-4">
                                <div class="text-center"><div class="text-2xl font-bold text-green-400">${habit.completedDays.length}</div><div class="text-purple-200 text-sm">${this.lang==='ru'?'–í—ã–ø–æ–ª–Ω–µ–Ω–æ':'Completed'}</div></div>
                                <div class="text-center"><div class="text-2xl font-bold text-blue-400">${habit.goal}</div><div class="text-purple-200 text-sm">${this.lang==='ru'?'–¶–µ–ª—å':'Goal'}</div></div>
                                <div class="text-center"><div class="text-2xl font-bold text-yellow-400">${Math.round(progress)}%</div><div class="text-purple-200 text-sm">${this.lang==='ru'?'–ü—Ä–æ–≥—Ä–µ—Å—Å':'Progress'}</div></div>
                            </div>
                            <div class="mb-4"><div class="w-full bg-white/20 rounded-full h-3"><div class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full" style="width:${progress}%"></div></div></div>
                            <button onclick="diary.toggleHabitDay(${habit.id})" class="w-full px-4 py-2 rounded-lg ${isCompletedToday?'bg-green-500 text-white':'bg-white/20 text-purple-200'}">${isCompletedToday?(this.lang==='ru'?'‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ':'‚úì Done'):(this.lang==='ru'?'–û—Ç–º–µ—Ç–∏—Ç—å':'Mark')}</button>
                        </div>
                    `;
                }).join('');
            }

            async addMemory() {
                const title = document.getElementById('memoryTitle').value.trim();
                const type = document.getElementById('memoryType').value;
                const startDate = document.getElementById('memoryStartDate').value;
                const notes = document.getElementById('memoryNotes').value.trim();
                if (!title || !startDate) { alert(this.lang==='ru'?'–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è':'Fill all fields'); return; }
                const memory = { id: Date.now(), title, type, startDate, notes, date: new Date().toLocaleString(this.lang==='ru'?'ru-RU':'en-US')};
                this.memories.unshift(memory);
                await this.saveMemories();
                this.renderMemories();
                document.getElementById('memoryForm').reset();
                document.getElementById('memoryStartDate').value = new Date().toISOString().split('T')[0];
                this.showNotification(this.lang==='ru'?'–í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ':'Memory added','success');
            }

            async deleteMemory(id) {
                if (confirm(this.lang==='ru'?'–£–¥–∞–ª–∏—Ç—å –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ?':'Delete memory?')) {
                    this.memories = this.memories.filter(m => m.id !== id);
                    await this.saveMemories();
                    this.renderMemories();
                    this.showNotification(this.lang==='ru'?'–í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ':'Memory deleted','info');
                }
            }

            renderMemories() {
                const list = document.getElementById('memoriesList');
                if (this.memories.length === 0) { list.innerHTML = `<p class="text-purple-200 text-center">${this.lang==='ru'?'–ù–µ—Ç –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π':'No memories'}</p>`; return; }
                list.innerHTML = this.memories.map(memory => `
                    <div class="note-card bg-black/30 backdrop-blur-sm border border-white/30 rounded-xl p-4">
                        <h3 class="text-white font-semibold text-lg mb-2">${memory.title}</h3>
                        <div class="text-purple-200 text-sm">–¢–∏–ø: ${memory.type}</div>
                        <div class="text-purple-200 text-sm">–ù–∞—á–∞–ª–æ: ${new Date(memory.startDate).toLocaleDateString(this.lang==='ru'?'ru-RU':'en-US')}</div>
                        ${memory.notes?`<div class="mt-2 text-orange-100 bg-black/20 rounded-lg p-3">${memory.notes}</div>`:''}
                        <div class="text-purple-300 text-xs mt-2">–î–æ–±–∞–≤–ª–µ–Ω–æ: ${memory.date}</div>
                    </div>
                `).join('');
            }

            switchTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.getElementById(tab + 'Tab').classList.add('active');
                document.getElementById('notesSection').classList.add('hidden');
                document.getElementById('habitsSection').classList.add('hidden');
                document.getElementById('memorySection').classList.add('hidden');
                document.getElementById(tab + 'Section').classList.remove('hidden');
            }

            updateCounts() {
                document.getElementById('notesCount').textContent = this.notes.length;
                document.getElementById('habitsCount').textContent = this.habits.length;
                document.getElementById('memoriesCount').textContent = this.memories.length;
            }

            showNotification(message, type) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }

            applyLang() {
                const translations = {
                    ru: {
                        'app-title': 'DailyBookimix',
                        'app-desc': '–ó–∞—â–∏—â—ë–Ω–Ω—ã–π –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫',
                        'cloud-label': '–û–±–ª–∞—á–Ω–æ',
                        'notes-tab': '–ó–∞–ø–∏—Å–∏',
                        'habits-tab': '–ü—Ä–∏–≤—ã—á–∫–∏',
                        'memory-tab': '–ê—Ä—Ö–∏–≤',
                        'new-note-title': '–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å',
                        'note-title-label': '–ó–∞–≥–æ–ª–æ–≤–æ–∫',
                        'note-category-label': '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
                        'note-content-label': '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ',
                        'save-note-btn': '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
                        'my-notes-title': '–ú–æ–∏ –∑–∞–ø–∏—Å–∏',
                        'notes-count-label': 'üìä –ó–∞–ø–∏—Å–µ–π: ',
                        'new-habit-title': '–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞',
                        'start-habit-btn': '–ù–∞—á–∞—Ç—å',
                        'my-habits-title': '–ú–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏',
                        'habits-count-label': '‚è∞ –ü—Ä–∏–≤—ã—á–µ–∫: ',
                        'new-memory-title': '–ù–æ–≤–æ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ',
                        'save-memory-btn': '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
                        'my-memories-title': '–ê—Ä—Ö–∏–≤ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π',
                        'memories-count-label': 'üìñ –í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π: '
                    },
                    en: {
                        'app-title': 'DailyBookimix',
                        'app-desc': 'Secure Daily Journal',
                        'cloud-label': 'Cloud',
                        'notes-tab': 'Notes',
                        'habits-tab': 'Habits',
                        'memory-tab': 'Archive',
                        'new-note-title': 'New Note',
                        'note-title-label': 'Title',
                        'note-category-label': 'Category',
                        'note-content-label': 'Content',
                        'save-note-btn': 'Save',
                        'my-notes-title': 'My Notes',
                        'notes-count-label': 'üìä Notes: ',
                        'new-habit-title': 'New Habit',
                        'start-habit-btn': 'Start',
                        'my-habits-title': 'My Habits',
                        'habits-count-label': '‚è∞ Habits: ',
                        'new-memory-title': 'New Memory',
                        'save-memory-btn': 'Save',
                        'my-memories-title': 'Memory Archive',
                        'memories-count-label': 'üìñ Memories: '
                    }
                };
                const trans = translations[this.lang];
                Object.keys(trans).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) el.textContent = trans[key];
                });

                // –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –∏ —Å–ø–∏—Å–∫–∏
                document.getElementById('notesSearch').placeholder = this.lang === 'ru' ? '–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É –∏–ª–∏ #—Ö—ç—à—Ç–µ–≥—É' : 'Search by text or #hashtag';

                document.getElementById('noteCategory').innerHTML = this.lang === 'ru' ? `
                    <option value="personal">–õ–∏—á–Ω–æ–µ</option>
                    <option value="work">–†–∞–±–æ—Ç–∞</option>
                    <option value="ideas">–ò–¥–µ–∏</option>
                    <option value="tasks">–ó–∞–¥–∞—á–∏</option>
                ` : `
                    <option value="personal">Personal</option>
                    <option value="work">Work</option>
                    <option value="ideas">Ideas</option>
                    <option value="tasks">Tasks</option>
                `;

                document.getElementById('filterCategory').innerHTML = this.lang === 'ru' ? `
                    <option value="all">–í—Å–µ</option>
                    <option value="personal">–õ–∏—á–Ω–æ–µ</option>
                    <option value="work">–†–∞–±–æ—Ç–∞</option>
                    <option value="ideas">–ò–¥–µ–∏</option>
                    <option value="tasks">–ó–∞–¥–∞—á–∏</option>
                ` : `
                    <option value="all">All</option>
                    <option value="personal">Personal</option>
                    <option value="work">Work</option>
                    <option value="ideas">Ideas</option>
                    <option value="tasks">Tasks</option>
                `;

                document.getElementById('habitName').placeholder = this.lang === 'ru' ? '–ù–∞–∑–≤–∞–Ω–∏–µ' : 'Name';
                document.getElementById('habitGoal').placeholder = this.lang === 'ru' ? '–¶–µ–ª—å (–¥–Ω–µ–π)' : 'Goal (days)';
                document.getElementById('habitDescription').placeholder = this.lang === 'ru' ? '–û–ø–∏—Å–∞–Ω–∏–µ' : 'Description';
                document.getElementById('memoryTitle').placeholder = this.lang === 'ru' ? '–ù–∞–∑–≤–∞–Ω–∏–µ' : 'Title';
                document.getElementById('memoryNotes').placeholder = this.lang === 'ru' ? '–ó–∞–º–µ—Ç–∫–∏' : 'Notes';

                // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å
                this.renderNotes(); this.renderHabits(); this.renderMemories();
                this.updateSwitchButtons();
            }

            async toggleLang() {
                this.lang = this.lang === 'ru' ? 'en' : 'ru';
                await CloudStorageManager.set('lang', this.lang);
                this.applyLang();
            }

            applyTheme() {
                document.body.classList.toggle('dark', this.theme === 'dark');
                this.updateSwitchButtons();
            }

            async toggleTheme() {
                this.theme = this.theme === 'light' ? 'dark' : 'light';
                await CloudStorageManager.set('theme', this.theme);
                this.applyTheme();
            }

            updateSwitchButtons() {
                document.getElementById('langSwitch').textContent = this.lang === 'ru' ? 'English' : '–†—É—Å—Å–∫–∏–π';
                document.getElementById('themeSwitch').textContent = this.theme === 'light' ? 'Dark' : 'Light';
                document.getElementById('cloud-label').textContent = this.lang === 'ru' ? '–û–±–ª–∞—á–Ω–æ' : 'Cloud';
            }

            async init() {
                // Telegram init (–∫–∞–∫ –≤ –ø–µ—Ä–≤–æ–π –≤–µ—Ä—Å–∏–∏)
                try { Telegram.WebApp.ready(); Telegram.WebApp.expand(); } catch(e) { console.warn('No Telegram WebApp'); }

                // load settings first to keep theme/lang as users had
                await this.loadSettings();
                await this.loadAll();

                // —Å–ª—É—à–∞—Ç–µ–ª–∏
                document.getElementById('noteForm').addEventListener('submit', async (e) => { e.preventDefault(); await this.addNote(); });
                document.getElementById('habitForm').addEventListener('submit', async (e) => { e.preventDefault(); await this.addHabit(); });
                document.getElementById('memoryForm').addEventListener('submit', async (e) => { e.preventDefault(); await this.addMemory(); });

                document.getElementById('notesTab').addEventListener('click', () => this.switchTab('notes'));
                document.getElementById('habitsTab').addEventListener('click', () => this.switchTab('habits'));
                document.getElementById('memoryTab').addEventListener('click', () => this.switchTab('memory'));

                document.getElementById('clearAll').addEventListener('click', async () => {
                    if (confirm(this.lang === 'ru' ? '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏?' : 'Delete all notes?')) {
                        this.notes = []; await this.saveNotes(); this.renderNotes(); this.showNotification(this.lang==='ru'?'–í—Å–µ –∑–∞–ø–∏—Å–∏ —É–¥–∞–ª–µ–Ω—ã':'All notes deleted','info');
                    }
                });

                document.getElementById('notesSearch').addEventListener('input', () => this.renderNotes());
                document.getElementById('filterCategory').addEventListener('change', () => this.renderNotes());

                document.getElementById('langSwitch').addEventListener('click', () => this.toggleLang());
                document.getElementById('themeSwitch').addEventListener('click', () => this.toggleTheme());

                // defaults
                document.getElementById('habitStartDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('memoryStartDate').value = new Date().toISOString().split('T')[0];
            }
        }

        // initialize
        const diary = new SimpleDiary();
        diary.init();

    </script>
</body>
</html>
